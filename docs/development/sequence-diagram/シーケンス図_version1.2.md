# シーケンス図

## 改版履歴
| 日付 | メンバー | バージョン | 概要 |
| :--- | :--- | :--- | :--- |
| 2025/12/04 | 小野田祐希、星野知史、蓬莱芽希 | 1.0 | 初版作成 |
| 2025/12/15 | 小野田祐希、星野知史、蓬莱芽希 | 1.1 | 初版修正 |
| 2025/12/16 | 小野田祐希、星野知史、蓬莱芽希 | 1.2 | ピアレビュー後修正 |
 
 ## UPDATE：注文
```mermaid
sequenceDiagram
  actor ユーザー
  autonumber
    Note right of ユーザー: 注文画面（カゴ表示状態）での操作
    ユーザー ->> 注文画面 : 「注文確定」をクリック
     
    注文画面 ->> サーブレット : POST method
    
    サーブレット ->> コントロール : 注文処理を依頼

    コントロール ->>+ DAO : 注文確定を依頼

    Note right of DAO : DB接続・トランザクション開始

    DAO ->>+ MySQL : SQL実行（UPDATE 注文状況=「調理中」/UPDATE 合計金額更新）
    
    MySQL -->>- DAO : 実行結果

    alt 更新成功
        DAO ->> MySQL : コミット
        DAO ->> MySQL : 接続切断
        DAO -->> コントロール : 成功
        
        コントロール -->> サーブレット : 成功を通知
        サーブレット -->> 注文画面 : 画面を再生成（カゴ空・メニュー一覧）
        注文画面 -->> ユーザー : メニュー一覧画面を表示

    else 更新失敗
        DAO ->> MySQL : ロールバック
        DAO ->> MySQL : 接続切断
        DAO -->>- コントロール : 失敗

        コントロール -->> サーブレット : 失敗を通知
        サーブレット -->> 注文画面 : エラー表示付きで再生成
        注文画面 -->> ユーザー : 注文画面を再表示（システムエラー）
    end
```

### 説明
ユーザーは注文端末の注文画面上で内容を確認し、「注文確定」ボタンをクリックする。これにより、サーブレットに対してPOSTメソッドにより、注文確定のリクエストが送信される。

サーブレットは、コントロールに注文処理を依頼する。
コントロールは、DAOへ処理を委ねる。DAOはデータベース接続を確立してトランザクションを開始し、該当する伝票IDのステータスを「調理中」に更新すると共に、合計金額の更新を行う。

* 更新に成功した場合<br>
   * DAOはコミットを実行して変更を確定させ、成功結果を返す。サーブレットはメニュー一覧画面（カゴが空の状態）を生成し、ユーザーに表示する。

* 更新に失敗した場合<br>
   * DAOはロールバックを実行して変更を取り消し、失敗結果を返す。サーブレットは注文画面を再生成し、システムエラーのメッセージと共にユーザーに表示する。
---

## UPDATE：決済

```mermaid
sequenceDiagram
  actor ユーザー
  autonumber
    Note right of ユーザー: 決済ボタン押下後、<br>入力画面が表示されている状態

    ユーザー ->> 画面 : 4桁目の数字を入力完了
    Note right of 画面: JSPで入力を検知し<br>自動的にPOST送信
    
    画面 ->> サーブレット : POST method (ユーザーID, 入力コード)
    サーブレット ->> コントロール : 決済・認証処理を依頼
    
    Note right of コントロール: STEP1: ユーザー情報取得
    コントロール ->>+ DAO : ユーザーIDを渡す

    Note right of DAO: DB接続

    DAO ->>+ MySQL : SQL実行（SELECT ユーザー情報）
    MySQL -->>- DAO : ハッシュ値・試行回数・残高
    DAO ->> MySQL : 接続切断
    DAO -->>- コントロール : ユーザーエンティティ

    Note right of コントロール: コントロール内で判断<br>(ハッシュ一致? 試行回数<3?)

    alt 認証成功 (コード一致)
        Note right of コントロール: STEP2: 決済実行
        コントロール ->>+ DAO : 決済確定を依頼
        
        Note right of DAO: DB接続・トランザクション開始
        DAO ->>+ MySQL : SQL実行（残高・ポイント更新 / 試行回数リセット）
        DAO ->> MySQL : SQL実行（UPDATE 注文状況=「決済済み」更新）
        DAO ->> MySQL : コミット
        DAO ->> MySQL : 接続切断
        DAO -->>- コントロール : 決済成功

        コントロール -->> サーブレット : 成功を通知
        サーブレット -->> ユーザー端末決済完了画面 : 成功画面生成
        ユーザー端末決済完了画面 -->> ユーザー : 決済完了を表示

    else 認証失敗 (コード不一致)
        Note right of コントロール: STEP2: 試行回数更新
        
        alt 3回未満 (再試行可)
            コントロール ->>+ DAO : 試行回数加算を依頼
            Note right of DAO: DB接続
            DAO ->> MySQL : SQL実行（UPDATE 試行回数+1）
            DAO ->> MySQL : コミット
            DAO ->> MySQL : 接続切断
            DAO -->>- コントロール : 更新完了
            
            コントロール -->> サーブレット : 認証失敗を通知
            サーブレット -->> 画面 : エラーメッセージ付きで再生成
            画面 -->> ユーザー : 「番号が違います」を表示
            
        else 3回目 (アカウントロック)
            コントロール ->>+ DAO : ロックアウトを依頼
            Note right of DAO: DB接続
            DAO ->> MySQL : SQL実行（UPDATE 試行回数+1 /UPDATE 状態=「ロックアウト」）
            DAO ->> MySQL : コミット
            DAO ->> MySQL : 接続切断
            DAO -->>- コントロール : ロック完了
            
            コントロール -->> サーブレット : ロックを通知
            サーブレット -->> アカウント停止画面 : 停止画面生成
            アカウント停止画面 -->> ユーザー : 「アカウントが停止されました」
        end
    end
```

### 説明
　
ユーザーがユーザー端末の決済画面で「決済」を選択すると、セキュリティコード入力画面が表示される。

ユーザーが4桁のセキュリティコードを入力し終えると、システムは自動的に入力を検知し、POSTメソッドでサーブレットへリクエストを送信する。サーブレットはコントロールへ処理を依頼する。

コントロールは、DAOを通じてデータベースから該当ユーザーの「登録済みセキュリティコード（ハッシュ値）」「現在の試行回数」「残高」を取得する。
コントロールが入力されたセキュリティコードと登録情報を照合する。

* 認証成功の場合（コード一致）<br>
    * コントロールはDAOに対し、決済確定処理を依頼する。DAOはデータベースに接続し、試行回数のリセット（0回）、残高とポイントの更新、および注文情報の「決済済み」への更新をトランザクション内で実行する。コミット後、サーブレットを通じて ユーザー端末決済完了画面を表示する。

* 認証失敗の場合（コード不一致）<br>
    * コントロールは現在の試行回数を確認する。
    * 3回未満の場合<br>
        * コントロールはDAOに対し、試行回数の加算（+1）のみを依頼する。更新後、セキュリティコード入力画面を再表示し、エラーメッセージを通知する。
    * 3回に達した場合 <br>
        * コントロールはDAOに対し、ユーザー状況を「ロックアウト」に変更するよう依頼する。DAOによる更新後、サーブレットは アカウント停止画面を表示する。
---

## READ：ユーザー認証

```mermaid
sequenceDiagram
  actor ユーザー
　autonumber
    Note right of ユーザー: ユーザー端末での操作
    ユーザー ->> ユーザーログイン画面 : ユーザー名・パスワードを入力し「ログイン」
     
    ユーザーログイン画面 ->> サーブレット : POST method
    
    サーブレット ->> コントロール : 認証処理を依頼
    
    Note right of コントロール: STEP1: ユーザー情報取得
    コントロール ->>+ DAO : ユーザー名を渡す
    
    Note right of DAO: DB接続
    DAO ->>+ MySQL : SQL実行（SELECT ユーザー情報）
    MySQL -->>- DAO : ハッシュ値・試行回数・状態
    DAO ->> MySQL : 接続切断
    DAO -->>- コントロール : ユーザーエンティティ

    Note right of コントロール: コントロール内で判断<br>(ロック中? パスワード一致?)

    alt アカウントロック中
        Note right of コントロール: 状態=「ロックアウト」
        コントロール -->> サーブレット : 認証失敗（ロック中）
        サーブレット -->>アカウント停止画面 : 画面生成
        アカウント停止画面 -->> ユーザー : 「アカウントの利用を停止しました」

    else 認証成功 (パスワード一致)
        Note right of コントロール: STEP2: 成功時更新
        コントロール ->>+ DAO : 試行回数リセットを依頼
        
        Note right of DAO: DB接続
        DAO ->> MySQL : SQL実行（UPDATE 試行回数=0）
        DAO ->> MySQL : コミット
        DAO ->> MySQL : 接続切断
        DAO -->>- コントロール : 更新成功
        
        コントロール -->> サーブレット : 認証成功を通知
        サーブレット ->> サーブレット : セッション生成
        サーブレット -->> ユーザーホーム画面 : ホーム画面を生成
        ユーザーホーム画面 -->> ユーザー : ログイン完了・ホーム表示

    else 認証失敗 (パスワード不一致)
        Note right of コントロール: STEP2: 失敗時更新
        
        alt 3回未満
            コントロール ->>+ DAO : 試行回数加算を依頼
             Note right of DAO: DB接続
             DAO ->> MySQL : SQL実行（UPDATE 試行回数+1）
             DAO ->> MySQL : コミット
             DAO ->> MySQL : 接続切断
             DAO -->>- コントロール : 更新完了

             コントロール -->> サーブレット : 認証失敗を通知
             サーブレット -->> ユーザーログイン画面 : エラー画面生成
             ユーザーログイン画面 -->> ユーザー : 「ユーザー名かパスワードが違います」
        else 3回目
            コントロール ->>+ DAO : ロックアウトを依頼
             Note right of DAO: DB接続
             DAO ->> MySQL : SQL実行（UPDATE 試行回数+1 /UPDATE 状態=「ロックアウト」）
             DAO ->> MySQL : コミット
             DAO ->> MySQL : 接続切断
             DAO -->>- コントロール : ロック完了

             コントロール -->> サーブレット : ロックを通知
             サーブレット -->> アカウント停止画面 : 画面生成
             アカウント停止画面 -->> ユーザー : 「アカウントが停止されました」
        end
    end
```

### 説明
ユーザーはユーザーログイン画面において、ユーザー名とパスワードを入力し「ログイン」ボタンをクリックする。これにより、サーブレットに対してPOSTメソッドにより、認証処理のリクエストが送信される。

サーブレットは、コントロールへ認証を依頼する。コントロールはDAOを呼び出し、入力されたユーザー名に該当するユーザー情報をデータベースから取得する。
DAOはデータを返すだけであり、照合判定はコントロールが行う。

* アカウントロックの確認<br>
    * 取得したユーザー状況が「ロックアウト」の場合、コントロールは即座に認証失敗とする。サーブレットはアカウント停止画面を表示する。

* パスワード照合<br>
    * ロックされていない場合、コントロールは入力されたパスワードをハッシュ化し、取得したDB上のハッシュ値と比較する。

    * 認証成功の場合<br>
        * コントロールはDAOに対し、試行回数のリセット（0回）を依頼する。DAOはトランザクションを開始して更新し、コミット後に成功結果を返す。サーブレットはセッションを生成し、ユーザーホーム画面へ遷移させる。

    * 認証失敗の場合（パスワード不一致）<br>
        * コントロールは現在の試行回数を確認し、処理を分岐させる。

        * 3回未満の場合<br>
            * コントロールはDAOに対し、試行回数の加算（+1）を依頼する。DAOは更新をコミットして成功結果を返す。サーブレットへは認証失敗が通知され、ユーザーログイン画面に「ユーザー名かパスワードが違います」というエラーメッセージが表示される。

        * 3回目に達した場合<br>
            * コントロールはDAOに対し、ユーザー状況を「ロックアウト」に変更し、試行回数を加算するよう依頼する。DAOは更新をコミットして成功結果を返す。サーブレットへはアカウントロックが通知され、アカウント停止画面が生成されて「アカウントが停止されました」という警告画面が表示される。
---

## READ：商品一覧表示
```mermaid
sequenceDiagram
  actor 管理者
  autonumber
    Note right of 管理者: サイドバー等の操作
    管理者 ->> 管理者注文情報画面 : 「商品」ボタンをクリック
     
    管理者注文情報画面 ->> サーブレット : GET method
    
    サーブレット ->> コントロール : 商品一覧取得を依頼
    コントロール ->>+ DAO : 全件取得を依頼

    Note right of DAO : DB接続

    DAO ->>+ MySQL : SQL実行（SELECT * FROM 商品情報）
    MySQL -->>- DAO : 商品リスト（Result Set）

    alt 取得成功
        DAO ->> MySQL : 接続切断
        DAO -->> コントロール : 商品エンティティのリスト
        
        コントロール -->> サーブレット : リストを渡す
        サーブレット -->> 商品一覧表示画面 : 画面を生成
        商品一覧表示画面 -->> 管理者 : 商品一覧を表示
    else 取得失敗
        DAO ->> MySQL : 接続切断
        DAO -->>- コントロール : エラー通知
        
        コントロール -->> サーブレット : 失敗を通知
        サーブレット -->> 管理者注文情報画面 : 画面を再生成
        管理者注文情報画面 -->> 管理者 : 画面を表示
    end
```

### 説明
管理者は管理者注文情報画面のメニューから「商品」を選択する。これにより、サーブレットに対してGETメソッドにより、商品一覧の表示リクエストが送信される。

サーブレットは、コントロールに商品一覧取得を依頼する。
コントロールは、DAOへ処理を委ねる。DAOはデータベース接続を確立し、全商品情報の取得（SELECT）を実行する。

* 取得に成功した場合<br>
    * DAOは接続を切断し、取得した商品エンティティのリストを返す。サーブレットは商品一覧表示画面を生成し、登録されている商品リストを管理者に表示する。

* 取得に失敗した場合<br>
    * DAOは接続を切断し、失敗結果を返す。サーブレットは管理者注文情報画面を再生成し、管理者に表示する。
---

## UPDATE：商品情報の更新

```mermaid
sequenceDiagram
 actor 管理者
 autonumber
    Note right of 管理者: 編集画面での操作
    管理者 ->> 商品更新フォーム画面 : 内容を修正し「更新」をクリック
     
    商品更新フォーム画面 ->> サーブレット : POST method
    
    サーブレット ->> コントロール : 更新処理を依頼
    コントロール ->>+ DAO : 商品エンティティを渡す

    Note right of DAO : DB接続・トランザクション開始

    DAO ->>+ MySQL : SQL実行（UPDATE 商品情報 SET ...）
    MySQL -->>- DAO : 実行結果

    alt 更新成功
        DAO ->> MySQL : コミット
        DAO ->> MySQL : 接続切断
        DAO -->> コントロール : 保存成功
        
        コントロール -->> サーブレット : 成功を通知
        サーブレット -->> 商品一覧表示画面 : 更新反映済みの画面を生成
        商品一覧表示画面 -->> 管理者 : 一覧画面へ遷移（「更新しました」）
    else 更新失敗
        DAO ->> MySQL : ロールバック
        DAO ->> MySQL : 接続切断
        DAO -->>- コントロール : 保存失敗
        
        コントロール -->> サーブレット : 失敗を通知
        サーブレット -->> 商品更新フォーム画面 : エラー表示付きで再生成
        商品更新フォーム画面 -->> 管理者 : 編集画面を再表示（エラーメッセージ）
    end
```


### 説明
管理者は商品更新フォーム画面において情報を修正し、「更新」ボタンをクリックする。これにより、サーブレットに対してPOSTメソッドにより、更新処理のリクエストが送信される。

サーブレットは、コントロールに更新処理を依頼する。
コントロールは、DAOへ処理を委ねる。DAOはデータベース接続を確立してトランザクションを開始し、対象となる商品情報の更新（UPDATE）を実行する。

* 更新に成功した場合<br>
    * DAOはコミットを実行して変更を確定させ、成功結果を返す。サーブレットは商品一覧表示画面を生成し、更新内容が反映されたリストを管理者に表示する。

* 更新に失敗した場合<br>
    * DAOはロールバックを実行して変更を取り消し、失敗結果を返す。サーブレットは商品更新フォーム画面を再生成し、エラーメッセージと共に管理者に表示する。
---

## DELETE：注文取り消し
```mermaid
sequenceDiagram
  actor ユーザー
  autonumber
    Note right of ユーザー: 注文画面（カゴ表示）での操作
    ユーザー ->> 注文画面 : 商品の「注文取り消し」ボタンをクリック
     
    注文画面 ->> サーブレット : POST method（伝票項目ID）
    
    サーブレット ->> コントロール : 削除処理を依頼
    コントロール ->>+ DAO : 伝票項目ID・伝票IDを渡す

    Note right of DAO : DB接続・トランザクション開始

    Note right of DAO : 1. 対象レコードの物理削除
    DAO ->>+ MySQL : SQL実行（DELETE FROM 注文商品情報...）
    MySQL -->>- DAO : 実行結果

    Note right of DAO : 2. 合計金額の再計算と更新
    DAO ->>+ MySQL : SQL実行（SELECT SUM... / UPDATE 注文情報...）
    MySQL -->>- DAO : 実行結果

    alt 削除成功
        DAO ->> MySQL : コミット
        DAO ->> MySQL : 接続切断
        DAO -->> コントロール : 削除成功
        
        コントロール -->> サーブレット : 成功を通知
        サーブレット -->> 注文画面 : 画面を再生成
        注文画面 -->> ユーザー : 商品が消えたカゴ画面を表示
    else 削除失敗
        DAO ->> MySQL : ロールバック
        DAO ->> MySQL : 接続切断
        DAO -->>- コントロール : 削除失敗
        
        コントロール -->> サーブレット : 失敗を通知
        サーブレット -->> 注文画面 : 画面を再生成
        注文画面 -->> ユーザー : カゴ画面を再表示
    end
```

### 説明

ユーザーは注文画面（注文カゴ一覧）において、不要な商品の「商品取り消し」ボタンをクリックする。これにより、サーブレットに対してPOSTメソッドにより、削除処理のリクエスト（伝票項目ID）が送信される。

サーブレットは、コントロールに削除処理を依頼する。

コントロールは、DAOへ処理を委ねる。DAOはデータベース接続を確立してトランザクションを開始し、まず対象となる商品のレコードをテーブルから削除する。

商品削除に伴う請求額の変更を反映させるため、残りの商品から合計金額を再計算し、注文情報の合計金額を更新する。

* 削除に成功した場合<br>
    * DAOはコミットを実行して変更を確定させ、成功結果を返す。サーブレットは注文画面を再生成し、該当商品が削除され、合計金額が更新された状態の画面をユーザーに表示する。

* 削除に失敗した場合<br>
    * DAOはロールバックを実行して変更を取り消し、失敗結果を返す。サーブレットは注文画面を再生成し、ユーザーに表示する。

## CREATE：ユーザー新規登録
```mermaid
sequenceDiagram
  actor ユーザー
  autonumber
    Note right of ユーザー: ユーザー情報入力（ユーザー名・パスワード・コード）
    ユーザー ->> 登録画面 : 「登録」をクリック
     
    登録画面 ->> サーブレット : POST method (入力情報)
    
    サーブレット ->> コントロール : 新規登録処理を依頼

    Note right of コントロール : 入力値チェック・ハッシュ化・ID生成

    コントロール ->>+ DAO : ユーザー名重複チェックを依頼
    DAO ->> MySQL : SQL実行（SELECT count(*) WHERE ユーザー名）
    MySQL -->> DAO : 件数返却
    DAO -->>- コントロール : チェック結果

    alt 重複あり / 入力不備
        コントロール -->> サーブレット : エラー（重複または不備）を通知
        サーブレット -->> 登録画面 : エラーメッセージ表示
        登録画面 -->> ユーザー : 登録画面を再表示（ユーザー名重複など）
    
    else 重複なし（登録処理へ）
        コントロール ->>+ DAO : ユーザー情報登録を依頼

        Note right of DAO : DB接続・トランザクション開始

        DAO ->>+ MySQL : SQL実行（INSERT ユーザー情報）
        MySQL -->>- DAO : 実行結果

        alt 登録成功
            DAO ->> MySQL : コミット
            DAO ->> MySQL : 接続切断
            DAO -->> コントロール : 成功
            
            コントロール -->> サーブレット : 成功を通知
            サーブレット -->> ユーザーホーム画面 : ユーザーホーム画面を生成
            ユーザーホーム画面 -->> ユーザー : ユーザーホーム画面を表示

        else 登録失敗
            DAO ->> MySQL : ロールバック
            DAO ->> MySQL : 接続切断
            DAO -->>- コントロール : 失敗

            コントロール -->> サーブレット : 失敗を通知
            サーブレット -->> 登録画面 : エラー表示付きで再生成
            登録画面 -->> ユーザー : 登録画面を再表示（データベース通信エラー）
        end
    end
```

### 説明
ユーザーはユーザー端末の登録画面でユーザー名・パスワード・セキュリティコードを入力し、「登録」ボタンをクリックする。これにより、サーブレットに対してPOSTメソッドにより、新規登録のリクエストが送信される。

サーブレットは、コントロールに入力情報の処理を依頼する。

コントロールは、まず入力チェック（桁数や文字種の確認）を行い、パスワードとセキュリティコードをハッシュ化する。
コントロールはDAOを通じてデータベースに問い合わせ、入力されたユーザー名が既に存在しないか（重複チェック）を確認する。

DAOは該当するユーザー名のデータ件数を返し、コントロールはその件数を見て判断を行う。

* 重複がある場合（件数が1件以上）、または入力不備がある場合<br>
    ・ コントロールは処理を中断してエラーを通知する。サーブレットは登録画面を再生成し、画面上に「ユーザー名が重複しています」等のメッセージを表示させる。

* 重複がない場合（件数が0件）<br>
    * コントロールはDAOに対してユーザー情報の新規登録（INSERT）を依頼する。
    * DAOはデータベース接続を確立してトランザクションを開始し、ユーザー情報をテーブルに登録する。

    * 登録に成功した場合<br>
        * DAOはコミットを実行して変更を確定させ、成功結果を返す。サーブレットは「ユーザーホーム画面」を生成し、ログイン状態となったユーザに表示する。

    * 登録に失敗した場合<br>
        * DAOはロールバックを実行して変更を取り消し、失敗結果を返す。サーブレットはシステムエラー（データベース通信失敗など）として登録画面を再生成し、エラーメッセージを表示する。


## 依存成果物のURL
 [機能仕様書](https://github.com/HazeyamaLab/se25g2/blob/main/docs/development/%E6%A9%9F%E8%83%BD%E4%BB%95%E6%A7%98%E6%9B%B8/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%80%80%E6%A9%9F%E8%83%BD%E4%BB%95%E6%A7%98%E6%9B%B8version9.1.md)
 
 [画面設計Figma](https://www.figma.com/design/lzUis57XlxyyV00hpEj4Gv/G2%E7%94%BB%E9%9D%A2%E8%A8%AD%E8%A8%88-%EF%BC%88%E7%AC%AC%EF%BC%92%E5%9B%9E%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%9A%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%EF%BC%89?node-id=0-1&t=FUHm8Ba6dhTTQ8JV-1)
 
